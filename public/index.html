<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–≥–∞–¥–∞–π —á–∏—Å–ª–æ | Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: var(--tg-theme-secondary-bg-color, #f2f2f2);
            --tg-theme-text-color: var(--tg-theme-text-color, #000000);
            --tg-theme-button-color: var(--tg-theme-button-color, #2481cc);
            --tg-theme-button-text-color: var(--tg-theme-button-text-color, #ffffff);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            min-height: 100vh;
            padding: 16px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .screen.active {
            display: block;
        }
        
        .header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #666;
            font-size: 14px;
        }
        
        .card {
            background: var(--tg-theme-secondary-bg-color, #ffffff);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .input-group {
            margin-bottom: 16px;
        }
        
        input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
        }
        
        button {
            width: 100%;
            padding: 14px;
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
            margin-bottom: 8px;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .button-secondary {
            background: transparent;
            color: var(--tg-theme-text-color);
            border: 1px solid #ddd;
        }
        
        .code-display {
            text-align: center;
            padding: 20px;
            background: var(--tg-theme-button-color);
            color: white;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 32px;
            font-weight: bold;
            letter-spacing: 4px;
        }
        
        .status {
            text-align: center;
            padding: 12px;
            background: #e3f2fd;
            border-radius: 8px;
            margin: 16px 0;
            color: #1976d2;
        }
        
        .result {
            margin: 16px 0;
            padding: 16px;
            border-radius: 8px;
            background: #f5f5f5;
        }
        
        .winner {
            background: #e8f5e9;
            border: 2px solid #4caf50;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ</h1>
            <p>–°–æ—Ä–µ–≤–Ω—É–π—Ç–µ—Å—å —Å –¥—Ä—É–≥–æ–º - –∫—Ç–æ –±–ª–∏–∂–µ —É–≥–∞–¥–∞–µ—Ç —á–∏—Å–ª–æ!</p>
        </div>
        
        <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
        <div id="mainMenu" class="screen active">
            <div class="card">
                <button onclick="showScreen('createGame')" class="button-primary">
                    üéÆ –°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É
                </button>
                <button onclick="showScreen('joinGame')" class="button-secondary">
                    üîó –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                </button>
            </div>
            <div class="card">
                <h3>–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:</h3>
                <ol style="margin-left: 20px; margin-top: 10px;">
                    <li>–°–æ–∑–¥–∞–π—Ç–µ –∏–≥—Ä—É –∏ –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º</li>
                    <li>–î—Ä—É–≥ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è –ø–æ –∫–æ–¥—É</li>
                    <li>–ó–∞–≥–∞–¥—ã–≤–∞–π—Ç–µ —á–∏—Å–ª–∞ –æ—Ç 1 –¥–æ 100</li>
                    <li>–ü–æ–±–µ–∂–¥–∞–µ—Ç —Ç–æ—Ç, –∫—Ç–æ –±–ª–∏–∂–µ –∫ –∑–∞–≥–∞–¥–∞–Ω–Ω–æ–º—É!</li>
                </ol>
            </div>
        </div>
        
        <!-- –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä—ã -->
        <div id="createGame" class="screen">
            <div class="card">
                <button onclick="createGame()" id="createBtn">
                    –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
                </button>
                <div id="waitingArea" style="display: none;">
                    <div class="code-display" id="gameCode"></div>
                    <p style="text-align: center;">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º –∫–æ–¥–æ–º —Å –¥—Ä—É–≥–æ–º</p>
                    <button onclick="copyCode()" class="button-secondary">
                        üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
                    </button>
                    <div class="status" id="waitingStatus">
                        <div class="loader"></div>
                        <p>–û–∂–∏–¥–∞–µ–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...</p>
                    </div>
                </div>
                <button onclick="showScreen('mainMenu')" class="button-secondary">
                    ‚Üê –ù–∞–∑–∞–¥
                </button>
            </div>
        </div>
        
        <!-- –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∏–≥—Ä–µ -->
        <div id="joinGame" class="screen">
            <div class="card">
                <div class="input-group">
                    <input type="text" id="roomCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–≥—Ä—ã" maxlength="6">
                </div>
                <button onclick="joinGame()" id="joinBtn">
                    –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                </button>
                <div class="status" id="joinStatus"></div>
                <button onclick="showScreen('mainMenu')" class="button-secondary">
                    ‚Üê –ù–∞–∑–∞–¥
                </button>
            </div>
        </div>
        
        <!-- –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω -->
        <div id="gameScreen" class="screen">
            <div class="card">
                <div class="status" id="gameStatus"></div>
                <div class="input-group">
                    <input type="number" id="guessInput" min="1" max="100" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 100">
                </div>
                <button onclick="submitGuess()" id="submitBtn">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–∏—Å–ª–æ
                </button>
            </div>
        </div>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div id="resultScreen" class="screen">
            <div class="card">
                <div id="resultStatus"></div>
                <button onclick="newGame()" style="margin-top: 20px;">
                    üéÆ –ù–æ–≤–∞—è –∏–≥—Ä–∞
                </button>
                <button onclick="showScreen('mainMenu')" class="button-secondary">
                    ‚Üê –í –º–µ–Ω—é
                </button>
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        
        // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
        tg.expand();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç–æ–≤—É—é —Å—Ö–µ–º—É
        document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#f2f2f2');
        document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
        document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#2481cc');
        document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#ffffff');
        
        let socket = null;
        let currentGameId = null;
        let myId = null;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }
        
        // –°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É
        function createGame() {
            const btn = document.getElementById('createBtn');
            btn.disabled = true;
            btn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';
            
            console.log('Creating game...');
            
            // Socket.IO –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —Ç–æ–º—É –∂–µ –¥–æ–º–µ–Ω—É
            socket = io({
                transports: ['websocket', 'polling'],
                reconnection: true
            });
            
            socket.on('connect', () => {
                console.log('Connected:', socket.id);
                myId = socket.id;
                socket.emit('create_game');
            });
            
            socket.on('game_created', (data) => {
                console.log('Game created:', data);
                currentGameId = data.gameId;
                document.getElementById('gameCode').textContent = currentGameId;
                document.getElementById('waitingArea').style.display = 'block';
                document.getElementById('createBtn').style.display = 'none';
            });
            
            socket.on('waiting', (data) => {
                console.log('Waiting:', data);
                document.getElementById('waitingStatus').innerHTML = 
                    `<div class="loader"></div><p>${data.message}</p>`;
            });
            
            socket.on('game_start', (data) => {
                console.log('Game started:', data);
                showScreen('gameScreen');
                document.getElementById('gameStatus').innerHTML = 
                    `<h3>üéÆ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!</h3><p>${data.message}</p>`;
            });
            
            socket.on('game_result', (data) => {
                console.log('Game result:', data);
                showScreen('resultScreen');
                const isWinner = data.winner === myId;
                const resultDiv = document.getElementById('resultStatus');
                
                resultDiv.innerHTML = `
                    <h3>${isWinner ? 'üéâ –ü–æ–±–µ–¥–∞!' : 'üò¢ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ'}</h3>
                    <p style="margin: 10px 0;">–ó–∞–≥–∞–¥–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ: <strong>${data.secretNumber}</strong></p>
                    ${data.guesses.map(guess => {
                        const isMe = guess.player === myId;
                        return `
                            <div class="result ${guess.player === data.winner ? 'winner' : ''}" 
                                 style="margin: 10px 0; padding: 12px;">
                                <p><strong>${isMe ? '–í—ã' : '–°–æ–ø–µ—Ä–Ω–∏–∫'}:</strong> ${guess.guess}</p>
                                <p>–†–∞–∑–Ω–∏—Ü–∞: ${guess.difference}</p>
                                ${guess.player === data.winner ? '<p>üèÜ –ë–ª–∏–∂–µ –∫ —á–∏—Å–ª—É!</p>' : ''}
                            </div>
                        `;
                    }).join('')}
                `;
                
                // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –ø–æ–±–µ–¥–µ (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
                if (isWinner && tg.isVibrationSupported) {
                    tg.HapticFeedback.impactOccurred('heavy');
                }
            });
            
            socket.on('error', (data) => {
                console.error('Error:', data);
                alert(`–û—à–∏–±–∫–∞: ${data.message}`);
                btn.disabled = false;
                btn.textContent = '–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É';
            });
            
            socket.on('disconnect', () => {
                console.log('Disconnected');
            });
        }
        
        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ
        function joinGame() {
            const gameId = document.getElementById('roomCode').value.trim().toUpperCase();
            if (!gameId || gameId.length !== 6) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–≥—Ä—ã');
                return;
            }
            
            console.log('Joining game:', gameId);
            
            const btn = document.getElementById('joinBtn');
            btn.disabled = true;
            btn.textContent = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...';
            
            socket = io({
                transports: ['websocket', 'polling'],
                reconnection: true
            });
            
            socket.on('connect', () => {
                console.log('Connected:', socket.id);
                myId = socket.id;
                socket.emit('join_game', gameId);
            });
            
            socket.on('game_start', (data) => {
                console.log('Game started:', data);
                showScreen('gameScreen');
                document.getElementById('gameStatus').innerHTML = 
                    `<h3>üéÆ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!</h3><p>${data.message}</p>`;
            });
            
            socket.on('game_result', (data) => {
                console.log('Game result:', data);
                showScreen('resultScreen');
                const isWinner = data.winner === myId;
                const resultDiv = document.getElementById('resultStatus');
                
                resultDiv.innerHTML = `
                    <h3>${isWinner ? 'üéâ –ü–æ–±–µ–¥–∞!' : 'üò¢ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ'}</h3>
                    <p style="margin: 10px 0;">–ó–∞–≥–∞–¥–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ: <strong>${data.secretNumber}</strong></p>
                    ${data.guesses.map(guess => {
                        const isMe = guess.player === myId;
                        return `
                            <div class="result ${guess.player === data.winner ? 'winner' : ''}" 
                                 style="margin: 10px 0; padding: 12px;">
                                <p><strong>${isMe ? '–í—ã' : '–°–æ–ø–µ—Ä–Ω–∏–∫'}:</strong> ${guess.guess}</p>
                                <p>–†–∞–∑–Ω–∏—Ü–∞: ${guess.difference}</p>
                                ${guess.player === data.winner ? '<p>üèÜ –ë–ª–∏–∂–µ –∫ —á–∏—Å–ª—É!</p>' : ''}
                            </div>
                        `;
                    }).join('')}
                `;
            });
            
            socket.on('error', (data) => {
                console.error('Error:', data);
                alert(`–û—à–∏–±–∫–∞: ${data.message}`);
                btn.disabled = false;
                btn.textContent = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è';
            });
        }
        
        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–≥–∞–¥–∫—É
        function submitGuess() {
            const guess = document.getElementById('guessInput').value;
            const guessNum = parseInt(guess);
            
            console.log('Submitting guess:', guess, 'for game:', currentGameId);
            
            if (!guess || isNaN(guessNum) || guessNum < 1 || guessNum > 100) {
                alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 100');
                return;
            }
            
            if (!socket || !socket.connected) {
                alert('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
                return;
            }
            
            if (!currentGameId) {
                alert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∏–≥—Ä—ã');
                return;
            }
            
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ...';
            
            socket.emit('submit_guess', {
                gameId: currentGameId,
                guess: guessNum
            });
            
            document.getElementById('guessInput').disabled = true;
            
            document.getElementById('gameStatus').innerHTML = 
                '<div class="loader"></div><p>–û–∂–∏–¥–∞–µ–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...</p>';
        }
        
        // –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∏–≥—Ä—ã
        function copyCode() {
            const code = document.getElementById('gameCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä!');
            });
        }
        
        // –ù–æ–≤–∞—è –∏–≥—Ä–∞
        function newGame() {
            if (socket) socket.disconnect();
            socket = null;
            currentGameId = null;
            showScreen('mainMenu');
        }
        
        // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        tg.onEvent('viewportChanged', (event) => {
            console.log('Viewport changed:', event);
        });
        
        // –ì–æ—Ç–æ–≤–æ
        tg.ready();
    </script>
</body>
</html>
